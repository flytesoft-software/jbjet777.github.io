var ShadowAnimator=function(){function C(a){var d=a.getUTCMonth()+1,c=a.getUTCDate(),b=a.getUTCFullYear(),f=a.getUTCHours(),e=a.getUTCMinutes();a=a.getUTCSeconds();2>=d&&(--b,d+=12);var g=Math.floor(b/100),d=Math.floor(365.25*(b+4716))+Math.floor(30.6001*(d+1))+c+(2-g+Math.floor(g/4))-1524.5,d=d+f/24+e/1440+a/86400;return d+=1537.5}function v(){if(w){var a=new Date;a.setTime(a.getTime()+x);b=C(a)}else 0<m&&(a=((new Date).getTime()-m)/864E5*300,n+=a),b=p+n,b>y?(b=p,n=m=0):m=(new Date).getTime();q?
b>=z&&b<=A?g.postMessage({cmd:"shadow",time:b.toString()}):(e++,k=null):(e++,k=null);h.postMessage({cmd:"shadow",time:b.toString()});var a=b,d=c.toDate(a);f.postMessage({cmd:"real",jd:(a-1537.5).toString(),time:d.getTime().toString()})}function D(a){var d=JSON.parse(a.data.moon_pos);a=JSON.parse(a.data.sun_pos);r&&r({moon_pos:d,sun_pos:a});console.log("MOON POSITION UPDATE.")}function E(a){t=JSON.parse(a.data.pen_shadow);e++;2===e&&(e=0,l&&l({pen_shadow:t,umb_shadow:k,date:c.toDate(b)}),v())}function F(a){k=
JSON.parse(a.data.umb_shadow);e++;2===e&&(e=0,l&&l({pen_shadow:t,umb_shadow:k,date:c.toDate(b)}),v())}var c=null,h=null,g=null,f=null,l=null,r=null,B=!1,b=0,p=0,y=0,z=0,A=0,m=0,n=0,e=0,k=null,t=null,q=!1,x=0,w=!1,u={};this.getMoonPosition=function(a,d,b){var c=0;d.altitude&&(c=d.altitude);d={latitude:d.latitude,longitude:d.longitude,altitude:c};r=b;f||(f=new Worker("moonWorker.js"),f.onmessage=D);b=C(a)-1537.5;f.postMessage({cmd:"location",coords:JSON.stringify(d)});f.postMessage({cmd:"real",jd:b.toString(),
time:a.getTime().toString()})};this.isAnimating=function(){return B};this.reset=function(){l=c=null;this.stop()};this.setEclipse=function(a){c=a};this.start=function(a,b,e){this.stop();e&&e.realTime&&(w=!0,e.dateOffset&&(x=e.dateOffset));if(c)B=!0,q=c.isTotalOrAnnular(),l=a,r=b,f||(f=new Worker("moonWorker.js")),f.onmessage=D,f.postMessage({cmd:"eclipse",eclipse:JSON.stringify(c)}),f.postMessage({cmd:"location",coords:JSON.stringify(u)}),h=new Worker("animateWorker.js"),h.onmessage=E,p=c.getPenumbraStartTimeJD(),
y=c.getPenumbraEndTimeJD(),h.postMessage({cmd:"eclipse",eclipse:JSON.stringify(c)}),q&&(g=new Worker("umbraWorker.js"),g.onmessage=F,z=c.getUmbraStartTimeJD(),A=c.getUmbraEndTimeJD(),g.postMessage({cmd:"eclipse",eclipse:JSON.stringify(c)})),v();else throw Error("Must set eclipse before starting animation.");};this.setCoords=function(a){u.latitude=a.latitude;u.longitude=a.longitude;u.altitude=a.altitude?a.altitude:0};this.stop=function(){B=!1;b=n=m=p=y=z=A=0;h&&(h.terminate(),h=null);g&&(g.terminate(),
g=null);t=k=null;e=0;w=q=!1;x=0}};